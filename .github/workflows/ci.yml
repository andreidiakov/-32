name: Java CI

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8

      - name: Build with Maven
        run: mvn clean install

      - name: Run tests
        run: mvn test
        continue-on-error: true

      - name: Store test results
        if: failure()
        run: |
          mkdir -p test-results
          find . -type f -name "*.xml" -exec cp {} test-results/ \;

      - name: Analyze test results and notify Telegram
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="Все ок"
          else
            FAILED_TESTS=$(grep -oP 'name="\K[^"]*' test-results/*.xml | paste -sd ", " -)
            if [ -z "$FAILED_TESTS" ]; then
              FAILED_TESTS="Не удалось получить информацию о проваленных тестах."
            fi
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="Тесты не пройдены: $FAILED_TESTS"
          fi
